var game = new Phaser.Game(1024, 756, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update});

function preload() {

    game.load.image('jugador', 'fotos/hero.png');
    game.load.image('jugador2', 'fotos/enemy.png');
    game.load.image('pelota', 'fotos/pelota.png');
    game.load.image('pared','fotos/pared.png');
    game.load.image('diana','fotos/diana.png');
}

//Creamos los objetos del juego
var sprite;
var sprite2;
var pelotas;
var pelotas2;
var pared;
var pared2;
var dianaia;
var dianaic;
var dianaib;
var dianada;
var dianadc;
var dianadb;

//angulo j2
var angle=0;
//tiempo entre disparos
var fireRate = 1000;
var nextFire = 0;
var nextFire2 = 0;
//Variables auxiliares
var vida=1;
var vida2=1;
var golpe=false;
var golpe2=false;
var tiempo=0;
var tiempo2=0;
var compruebadianas=0;
var compruebadianas2=0;
var z1xd=900;
var z1xi=524;
var z1ya=100;
var z1yb=600;
var z2xd=500;
var z2xi=100;
var z2ya=100;
var z2yb=600;


function create() 
{
    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.stage.backgroundColor = '#757575'; 

    //Creamos las pelotas del jugador 1
    pelotas = game.add.group();
    pelotas.enableBody = true;
    pelotas.physicsBodyType = Phaser.Physics.ARCADE;

    pelotas.createMultiple(50, 'pelota');
    pelotas.setAll('checkWorldBounds', true);
    pelotas.setAll('outOfBoundsKill', true);

    //Creamos las pelotas del jugador 2
    pelotas2 = game.add.group();
    pelotas2.enableBody = true;
    pelotas2.physicsBodyType = Phaser.Physics.ARCADE;

    pelotas2.createMultiple(50, 'pelota');
    pelotas2.setAll('checkWorldBounds', true);
    pelotas2.setAll('outOfBoundsKill', true);

    //Creamos las paredes 
    pared = game.add.sprite(512,100,'pared');
    
    pared2 = game.add.sprite(512,656,'pared');

    //Creamos los jugadores
    sprite = game.add.sprite(700, 378, 'jugador');
    sprite.anchor.set(0.5);

    sprite2 = game.add.sprite(324, 378, 'jugador2');
    sprite2.anchor.set(0.5);

    //Creamos las dianas 
    //i=izquierda, d=derecha, a=arriba, c=centro, b=abajo
    dianaia = game.add.sprite(40, 228, 'diana');
    dianaic = game.add.sprite(40, 378, 'diana');
    dianaib = game.add.sprite(40, 528, 'diana');
    dianada = game.add.sprite(984, 228, 'diana');
    dianadc = game.add.sprite(984, 378, 'diana');
    dianadb = game.add.sprite(984, 528, 'diana');

    //Asignamos las fisicas a las paredes, a los jugadores y a las dianas
    game.physics.enable(pared, Phaser.Physics.ARCADE);
    game.physics.enable(pared2, Phaser.Physics.ARCADE);
    game.physics.enable(sprite, Phaser.Physics.ARCADE);
    game.physics.enable(sprite2, Phaser.Physics.ARCADE);
    game.physics.enable(dianaia, Phaser.Physics.ARCADE);
    game.physics.enable(dianaic, Phaser.Physics.ARCADE);
    game.physics.enable(dianaib, Phaser.Physics.ARCADE);
    game.physics.enable(dianada, Phaser.Physics.ARCADE);
    game.physics.enable(dianadc, Phaser.Physics.ARCADE);
    game.physics.enable(dianadb, Phaser.Physics.ARCADE);

    sprite.body.allowRotation = false;
    sprite2.body.allowRotation = false;

    //Hacemos que los objetos no se puedan escapar de la ventana
    sprite.body.collideWorldBounds = true;
    sprite2.body.collideWorldBounds = true;

    //Hacemos que las paredes y las dianas no se puedan mover
    pared.body.immovable = true;
    pared2.body.immovable = true;
    dianaia.body.immovable = true;
    dianaic.body.immovable = true;
    dianaib.body.immovable = true;
    dianada.body.immovable = true;
    dianadc.body.immovable = true;
    dianadb.body.immovable = true;

    //Las teclas up, down, right y left son mas faciles de usar
    teclas = game.input.keyboard.createCursorKeys();

    //Asignamos la velocidad de las paredes
    pared.body.velocity.x=100;
    pared2.body.velocity.x=-100;
}

function update() 
{

    sprite.rotation = game.physics.arcade.angleToPointer(sprite);
    sprite2.rotation = angle;

    //Comprobamos si el jugador 1 tiene el efecto de choque con la pelota
    if(golpe!=true)
    {
        pararjugador(sprite);
    }
    else
    {
        tiempo++;
        if(tiempo==10*vida)
        {
            golpe=false;
            tiempo=0;
            vida=vida*2;
        }
    }

    //Comprobamos si el jugador 2 tiene el efecto de choque con la pelota
    if(golpe2!=true)
    {
         pararjugador(sprite2);
    }
    else
    {
        tiempo2++;
        if(tiempo2==10*vida2)
        {
            golpe2=false;
            tiempo2=0;
            vida2=vida2*2;
        }
    }

    //Hacemos que las paredes se muevan de un lado a otro
    if(pared.body.position.x>=854 || pared.body.position.x<=170)
    {
        pared.body.velocity.x=-pared.body.velocity.x;
        pared2.body.velocity.x=-pared2.body.velocity.x;
    }

    //Creamos las colisiones
    game.physics.arcade.collide(sprite2, pelotas, golpeajugador2);
    game.physics.arcade.collide(sprite, pelotas2, golpeajugador);
    game.physics.arcade.collide(pared, pelotas);
    game.physics.arcade.collide(pared, pelotas2);
    game.physics.arcade.collide(pared2, pelotas);
    game.physics.arcade.collide(pared2, pelotas2);
    game.physics.arcade.collide(dianada, pelotas2, golpeadiana2);
    game.physics.arcade.collide(dianadc, pelotas2, golpeadiana2);
    game.physics.arcade.collide(dianadb, pelotas2, golpeadiana2);
    game.physics.arcade.collide(dianaia, pelotas, golpeadiana);
    game.physics.arcade.collide(dianaic, pelotas, golpeadiana);
    game.physics.arcade.collide(dianaib, pelotas, golpeadiana);
    
    //jugador 1 teclas
    if(golpe!=true)
    {
        if (teclas.left.isDown)
        {
            sprite.body.velocity.x = -150;       
        }
    
        if (teclas.right.isDown)
        {
            sprite.body.velocity.x = 150; 
        }

        if (teclas.up.isDown)
        {
            sprite.body.velocity.y = -150;
        }

        if (teclas.down.isDown)
        {
            sprite.body.velocity.y = 150;
        }

        if (game.input.activePointer.isDown)
        {
            fire();
        }
    }

    //jugador 2 teclas
    if(golpe2!=true)
    { 
        if(game.input.keyboard.isDown(Phaser.KeyCode.A))
        {
            sprite2.body.velocity.x = -150;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.W))
        {
            sprite2.body.velocity.y = -150;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.S))
        {
            sprite2.body.velocity.y = 150;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.D))
        {
            sprite2.body.velocity.x = 150;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.H))
        {
            angle-=0.1;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.J))
        {
            angle+=0.1;
        }

        if(game.input.keyboard.isDown(Phaser.KeyCode.SPACEBAR))
        {
            fire2(sprite2);
        }
    }

    //Comprobamos si las dianas de la izquierda estan dadas
    if(compruebadianas==3)
    {
        reducezona2();
        console.log("Se reduce la zona 2");
        compruebadianas=0;
    }

    //Comprobamos si las dianas de la derecha estan dadas
    if(compruebadianas2==3)
    {
        reducezona();
        console.log("Se reduce la zona 1");
        compruebadianas2=0;
    }

    pierdej1(sprite);
    pierdej2(sprite2);

}

//Disparo pelotas jugador 1
function fire()
{

    if (game.time.now > nextFire && pelotas.countDead() > 0)
    {
        nextFire = game.time.now + fireRate;

        var pelota = pelotas.getFirstDead();
        
        pelota.reset(sprite.x - 8, sprite.y - 8);
        
        game.physics.arcade.moveToPointer(pelota, 500);

        pelota.body.bounce.set(1);
    }

}

//Disparo pelotas jugador 2
function fire2(sprite2)
{

    if (game.time.now > nextFire2 && pelotas2.countDead() > 0)
    {
        nextFire2 = game.time.now + fireRate;

        var pelota2 = pelotas2.getFirstDead();

        pelota2.reset(sprite2.x - 8, sprite2.y - 8);

        pelota2.body.velocity.copyFrom(game.physics.arcade.velocityFromAngle(sprite2.angle, 500));

        pelota2.body.bounce.set(1);
    }

}

function golpeadiana2(pelota2)
{
    pelota2.kill();
    compruebadianas2++;
}

function golpeadiana(pelota)
{
    pelota.kill();
    compruebadianas++;
}

function golpeajugador2(sprite2,pelota)
{
    golpe2=true;
    golpear(pelota);
    pelota.kill();
}

function golpeajugador(sprite,pelota2)
{
    golpe=true;
    golpear2(pelota2);
    pelota2.kill();
}

function pararjugador(sprite)
{
    if(sprite.body.velocity.y != 0)
    {
        sprite.body.velocity.y=0;
    }

    if(sprite.body.velocity.x != 0)
    {
        sprite.body.velocity.x=0;
    }

}

function golpear(pelotas)
{
    sprite.body.velocity.x = pelotas.body.velocity.x;
    sprite.body.velocity.y = pelotas.body.velocity.y;
}

function golpear2(pelotas2)
{
    sprite2.body.velocity.x = pelotas2.body.velocity.x;
    sprite2.body.velocity.y = pelotas2.body.velocity.y;
}

function reducezona()
{
    z1xd=z1xd-100;
    z1xi=z1xi+100;
    z1ya=z1ya+100;
    z1yb=z1yb-100;
}

function reducezona2()
{
    z2xd=z2xd-100;
    z2xi=z2xi+100;
    z2ya=z2ya+100;
    z2yb=z2yb-100;
}

function pierdej1(sprite)
{
    if(sprite.body.position.x>z1xd || sprite.body.position.x<z1xi || sprite.body.position.y<z1ya || sprite.body.position.y>z1yb)
    {
        console.log("pierde j1");
        sprite.body.position.x=700;
        sprite.body.position.y=378;
    }
}

function pierdej2()
{
    if(sprite2.body.position.x>z2xd || sprite2.body.position.x<z2xi || sprite2.body.position.y<z2ya || sprite2.body.position.y>z2yb)
    {
        console.log("pierde j2");
        sprite2.body.position.x=324;
        sprite2.body.position.y=378;
    }
}